# Kubernetes 应用市场 (App Market) 需求规格说明书 (V3 - 增强配置版)

## 1. 项目概述

本系统是一个高度可定制的企业级 K8s 应用商店。后端采用 **Go 语言**，支持对 Helm `values.yaml` 的深度解析与动态渲染，通过管理员预设的“引导模式”降低普通用户部署复杂应用的门槛。

---

## 2. 核心功能模块

### 2.1 应用仓库与配置管理 (仅管理员)

该模块不仅管理包的上下架，还负责定义应用的“部署模板”。

| 功能点 | 详细描述 | 权限限制 |
| --- | --- | --- |
| **上架/下架操作** | 管理 **Gitee Helm Repo** 中的 Chart 状态，仅上架应用对普通用户可见。 | **仅限管理员** |
| **部署参数配置** | **默认参数设置**：管理员可预设一组 `values.yaml` 的默认值。<br>

<br>**必输参数定义**：管理员可指定特定的 Key 为“必填项”（如：域名、数据库密码），若用户未填写则禁止部署。 | **仅限管理员** |
| **引导页面配置** | 后端解析 `values.yaml` 生成参数树，管理员勾选哪些参数进入“快捷部署”页面。 | **仅限管理员** |

### 2.2 应用浏览

用户可以查看所有已上架的应用，并查阅由管理员配置好的默认部署说明。

### 2.3 应用部署 (核心隔离与动态配置)

用户在部署时可根据技术熟练度选择不同的路径。

| 部署模式 | 功能描述 | 业务逻辑 |
| --- | --- | --- |
| **快捷部署 (引导模式)** | **极简体验**：仅展示管理员预设的“引导页面”。<br>

<br>**自动填充**：未显示的参数自动填充管理员设置的默认值。<br>

<br>**强制校验**：系统自动校验管理员设定的“必输参数”是否已填充。 | 适合业务开发人员 |
| **高级部署 (YAML 模式)** | **全量控制**：展示完整的 `values.yaml` 内容供用户编辑。<br>

<br>**基础校验**：依然执行管理员设定的“必输参数”及 YAML 格式合法性校验。 | 适合运维/高级开发 |

**【部署前置逻辑】**：系统必须先调用预留的第三方接口获取用户的 **Kubeconfig**，确保部署行为在用户授权的 Namespace 内进行。

### 2.4 应用实例管理

* **多租户隔离**：用户仅能查看、升级或回滚自己通过快捷/高级模式部署的实例。
* **状态回显**：实例详情页需区分展示“引导参数值”和“全量配置值”。

---

## 3. 后端技术实现要点 (Go)

### 3.1 `values.yaml` 解析逻辑

后端需要一套机制来支撑前端的动态渲染和管理员的配置：

1. **Schema 提取**：使用 Go 解析 `values.yaml`（建议结合 `yq` 逻辑或 `sigs.k8s.io/yaml`），将其转换为扁平化的键值对结构。
2. **配置叠加 (Merge)**：
* 层级一：Chart 原始 `values.yaml`。
* 层级二：管理员预设的 Default Values（覆盖层级一）。
* 层级三：用户在界面输入的值（最终生效值）。
* **Go 实现**：建议使用 `imdario/mergo` 库实现深层 Map 的合并。



### 3.2 动态表单与校验器

* **Metadata 存储**：在数据库中存储一份映射表，记录 `ChartID + Version` 对应的 `RequiredKeys` (必输列表) 和 `DefaultMap` (默认值集合)。
* **校验引擎**：在执行 `helm install` 前，Go 后端需递归检查用户提交的 JSON 对象中是否包含所有 `RequiredKeys`。

### 3.3 凭证获取接口预留

```go
// 预留的第三方接口调用定义
type KubeconfigProvider interface {
    // 根据当前登录用户 ID 获取 Kubeconfig 字节流
    GetKubeconfig(ctx context.Context, userID string) ([]byte, error)
}

```

---

## 4. 交互流程示例 (用户侧)

1. **选择应用**：用户在市场点击“部署”。
2. **选择模式**：页面弹出“快捷部署”和“高级部署”选项。
3. **快捷路径**：
* 后端返回经过滤后的参数列表（仅含管理员选中的项）。
* 用户输入必输项（如 `replicaCount`）。
* 后端调用第三方接口获取 Kubeconfig。
* 后端合并：原始配置 + 管理员默认值 + 用户输入值 -> 执行部署。

